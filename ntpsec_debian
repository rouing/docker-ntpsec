FROM registry.gitlab.com/rouing/docker-ntpsec/builder/debian:latest AS builder
FROM debian:latest

LABEL maintainer "rouing"
LABEL description "NTP reference implementation, refactored for security"

ENV NTPSEC_RUN_DEPS python3 libssl1.1 libcap2 libseccomp2 pps-tools libgps26 libbsd0 libavahi-compat-libdnssd1

RUN apk add --no-cache $NTPSEC_RUN_DEPS

COPY --from=builder /usr/sbin/ntpd /usr/sbin/ntpd
COPY --from=builder /usr/bin/ntp* /usr/bin/
COPY --from=builder /usr/lib/python3.8/site-packages/ntp/ /usr/lib/python3.8/site-packages/ntp/


COPY ntp.conf /etc/ntp.conf

RUN set -x && \
    mkdir -p /var/ntpsec/

RUN ntpd --version

EXPOSE 123/udp
EXPOSE 123/tcp

ENTRYPOINT ["/usr/sbin/ntpd"]

CMD ["-n", "-c", "/etc/ntp.conf"]
